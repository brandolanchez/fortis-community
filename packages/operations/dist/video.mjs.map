{"version":3,"sources":["../src/video.ts"],"sourcesContent":["/**\r\n * @snapie/operations/video - Video Upload Module\r\n * \r\n * Optional module for 3Speak video upload integration.\r\n * Only import this if you need video upload functionality.\r\n * \r\n * @example\r\n * ```typescript\r\n * import { uploadVideoTo3Speak } from '@snapie/operations/video';\r\n * \r\n * const result = await uploadVideoTo3Speak(file, {\r\n *   apiKey: '...',\r\n *   owner: 'username',\r\n *   onProgress: (progress, status) => console.log(progress, status)\r\n * });\r\n * \r\n * console.log(result.embedUrl);\r\n * ```\r\n */\r\n\r\n/**\r\n * Video upload progress callback\r\n */\r\nexport type VideoProgressCallback = (\r\n    progress: number,\r\n    status: 'uploading' | 'processing' | 'complete' | 'error'\r\n) => void;\r\n\r\n/**\r\n * Video upload result\r\n */\r\nexport interface VideoUploadResult {\r\n    /** The embed URL to include in posts */\r\n    embedUrl: string;\r\n    /** The video ID (permlink part) */\r\n    videoId: string;\r\n}\r\n\r\n/**\r\n * Options for video upload\r\n */\r\nexport interface VideoUploadOptions {\r\n    /** 3Speak API key */\r\n    apiKey: string;\r\n    /** Hive username of the uploader */\r\n    owner: string;\r\n    /** App name for metadata (default: \"snapie\") */\r\n    appName?: string;\r\n    /** Title for the video */\r\n    title?: string;\r\n    /** Description for the video */\r\n    description?: string;\r\n    /** Tags for the video (comma-separated or array) */\r\n    tags?: string | string[];\r\n    /** Community Hive account (e.g., \"hive-148971\") */\r\n    community?: string;\r\n    /** Progress callback */\r\n    onProgress?: VideoProgressCallback;\r\n}\r\n\r\n/**\r\n * Upload a video to 3Speak using TUS protocol\r\n * \r\n * @param file - Video file to upload\r\n * @param options - Upload options\r\n * @returns Promise resolving to embed URL and video ID\r\n */\r\nexport async function uploadVideoTo3Speak(\r\n    file: File,\r\n    options: VideoUploadOptions\r\n): Promise<VideoUploadResult> {\r\n    // Dynamic import to avoid bundling tus-js-client when not needed\r\n    const tus = await import('tus-js-client');\r\n\r\n    return new Promise((resolve, reject) => {\r\n        let embedUrl: string | null = null;\r\n\r\n        const upload = new tus.Upload(file, {\r\n            endpoint: 'https://embed.3speak.tv/uploads',\r\n            chunkSize: 10 * 1024 * 1024, // 10MB chunks for reliable large file uploads\r\n            retryDelays: [0, 3000, 5000, 10000, 20000],\r\n            metadata: {\r\n                filename: file.name,\r\n                owner: options.owner,\r\n                frontend_app: options.appName ?? 'snapie',\r\n                short: 'true',\r\n                title: options.title ?? file.name,\r\n                description: options.description ?? '',\r\n                tags: Array.isArray(options.tags) ? options.tags.join(',') : (options.tags ?? ''),\r\n                community: options.community ?? ''\r\n            },\r\n            headers: {\r\n                'X-API-Key': options.apiKey\r\n            },\r\n            onError: (error) => {\r\n                options.onProgress?.(0, 'error');\r\n                reject(error);\r\n            },\r\n            onProgress: (bytesUploaded, bytesTotal) => {\r\n                const percentage = (bytesUploaded / bytesTotal) * 100;\r\n                options.onProgress?.(Math.round(percentage), 'uploading');\r\n            },\r\n            onAfterResponse: (req, res) => {\r\n                const url = res.getHeader('X-Embed-URL');\r\n                if (url) {\r\n                    embedUrl = url;\r\n                }\r\n            },\r\n            onSuccess: () => {\r\n                if (embedUrl) {\r\n                    options.onProgress?.(100, 'complete');\r\n                    const videoId = extractVideoIdFromEmbedUrl(embedUrl);\r\n                    resolve({\r\n                        embedUrl,\r\n                        videoId: videoId ?? ''\r\n                    });\r\n                } else {\r\n                    options.onProgress?.(0, 'error');\r\n                    reject(new Error('Failed to get embed URL from server'));\r\n                }\r\n            }\r\n        });\r\n\r\n        upload.start();\r\n    });\r\n}\r\n\r\n/**\r\n * Extract video ID from 3Speak embed URL\r\n * \r\n * @example\r\n * // Input: \"https://play.3speak.tv/embed?v=username/abc123\"\r\n * // Output: \"abc123\"\r\n */\r\nexport function extractVideoIdFromEmbedUrl(embedUrl: string): string | null {\r\n    try {\r\n        const url = new URL(embedUrl);\r\n        const videoParam = url.searchParams.get('v');\r\n        if (videoParam) {\r\n            const parts = videoParam.split('/');\r\n            return parts[1] ?? null;\r\n        }\r\n        return null;\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\n/**\r\n * Set thumbnail for a 3Speak video\r\n * \r\n * @param videoId - The video ID (permlink part, e.g., \"abc123\")\r\n * @param thumbnailUrl - URL of the thumbnail image\r\n * @param apiKey - 3Speak API key\r\n */\r\nexport async function set3SpeakThumbnail(\r\n    videoId: string,\r\n    thumbnailUrl: string,\r\n    apiKey: string\r\n): Promise<void> {\r\n    const response = await fetch(`https://embed.3speak.tv/video/${videoId}/thumbnail`, {\r\n        method: 'POST',\r\n        headers: {\r\n            'Content-Type': 'application/json',\r\n            'X-API-Key': apiKey\r\n        },\r\n        body: JSON.stringify({ thumbnail_url: thumbnailUrl })\r\n    });\r\n\r\n    if (!response.ok) {\r\n        throw new Error(`Failed to set thumbnail: ${response.status} - ${response.statusText}`);\r\n    }\r\n}\r\n\r\n/**\r\n * Extract a thumbnail frame from a video file (browser only)\r\n * \r\n * @param file - Video file\r\n * @param seekTime - Time in seconds to capture frame (default: 0.5)\r\n * @returns Promise resolving to thumbnail blob\r\n */\r\nexport async function extractVideoThumbnail(\r\n    file: File,\r\n    seekTime: number = 0.5\r\n): Promise<Blob> {\r\n    return new Promise((resolve, reject) => {\r\n        const url = URL.createObjectURL(file);\r\n        const video = document.createElement('video');\r\n\r\n        video.src = url;\r\n        video.crossOrigin = 'anonymous';\r\n        video.muted = true;\r\n\r\n        video.addEventListener('loadeddata', () => {\r\n            video.currentTime = seekTime;\r\n        });\r\n\r\n        video.addEventListener('seeked', () => {\r\n            const canvas = document.createElement('canvas');\r\n            canvas.width = video.videoWidth;\r\n            canvas.height = video.videoHeight;\r\n\r\n            const ctx = canvas.getContext('2d');\r\n            if (!ctx) {\r\n                reject(new Error('Failed to get canvas context'));\r\n                return;\r\n            }\r\n\r\n            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);\r\n\r\n            canvas.toBlob(\r\n                (blob) => {\r\n                    URL.revokeObjectURL(url);\r\n                    if (blob) {\r\n                        resolve(blob);\r\n                    } else {\r\n                        reject(new Error('Failed to create thumbnail blob'));\r\n                    }\r\n                },\r\n                'image/jpeg',\r\n                0.9\r\n            );\r\n        });\r\n\r\n        video.addEventListener('error', () => {\r\n            URL.revokeObjectURL(url);\r\n            reject(new Error('Failed to load video'));\r\n        });\r\n\r\n        video.load();\r\n    });\r\n}\r\n\r\n/**\r\n * Upload a file to IPFS (3Speak supernode)\r\n * \r\n * @param file - File or Blob to upload\r\n * @param endpoint - IPFS API endpoint (default: 3Speak supernode)\r\n * @returns IPFS URL of the uploaded file\r\n */\r\nexport async function uploadToIPFS(\r\n    file: File | Blob,\r\n    endpoint: string = 'http://65.21.201.94:5002/api/v0/add'\r\n): Promise<string> {\r\n    const formData = new FormData();\r\n    formData.append('file', file);\r\n\r\n    const response = await fetch(endpoint, {\r\n        method: 'POST',\r\n        body: formData\r\n    });\r\n\r\n    if (!response.ok) {\r\n        throw new Error(`IPFS upload failed: ${response.status} - ${response.statusText}`);\r\n    }\r\n\r\n    const responseText = await response.text();\r\n    const lines = responseText.trim().split('\\n');\r\n    const lastLine = lines[lines.length - 1];\r\n    const result = JSON.parse(lastLine);\r\n\r\n    return `https://ipfs.3speak.tv/ipfs/${result.Hash}`;\r\n}\r\n\r\n/**\r\n * Helper to upload video with automatic thumbnail generation\r\n * \r\n * @param file - Video file\r\n * @param options - Upload options including API key\r\n * @returns Video upload result with optional thumbnail URL\r\n */\r\nexport async function uploadVideoWithThumbnail(\r\n    file: File,\r\n    options: VideoUploadOptions & {\r\n        /** Custom thumbnail upload function */\r\n        uploadThumbnail?: (blob: Blob) => Promise<string>;\r\n    }\r\n): Promise<VideoUploadResult & { thumbnailUrl?: string }> {\r\n    // Start video upload and thumbnail extraction in parallel\r\n    const [videoResult, thumbnailBlob] = await Promise.all([\r\n        uploadVideoTo3Speak(file, options),\r\n        extractVideoThumbnail(file).catch(() => null)\r\n    ]);\r\n\r\n    let thumbnailUrl: string | undefined;\r\n\r\n    if (thumbnailBlob) {\r\n        try {\r\n            // Upload thumbnail\r\n            thumbnailUrl = options.uploadThumbnail\r\n                ? await options.uploadThumbnail(thumbnailBlob)\r\n                : await uploadToIPFS(thumbnailBlob);\r\n\r\n            // Set it on 3Speak\r\n            if (videoResult.videoId) {\r\n                await set3SpeakThumbnail(videoResult.videoId, thumbnailUrl, options.apiKey);\r\n            }\r\n        } catch (error) {\r\n            console.warn('Thumbnail processing failed (video still works):', error);\r\n        }\r\n    }\r\n\r\n    return {\r\n        ...videoResult,\r\n        thumbnailUrl\r\n    };\r\n}\r\n"],"mappings":"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","names":[]}