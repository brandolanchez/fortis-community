{"version":3,"sources":["../src/core.ts"],"sourcesContent":["/**\r\n * @snapie/operations - Core Module\r\n * \r\n * Core utilities for building Hive blockchain operations.\r\n * This module has no external dependencies beyond @hiveio/dhive types.\r\n */\r\n\r\nimport type { CommentOperation, CommentOptionsOperation, Operation } from '@hiveio/dhive';\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\n\r\n/**\r\n * Beneficiary recipient for post rewards\r\n */\r\nexport interface Beneficiary {\r\n    account: string;\r\n    /** Weight in basis points (100 = 1%, 1000 = 10%, 10000 = 100%) */\r\n    weight: number;\r\n}\r\n\r\n/**\r\n * Input for building a comment/post operation\r\n */\r\nexport interface CommentInput {\r\n    /** Author's Hive username */\r\n    author: string;\r\n    \r\n    /** Post body in markdown */\r\n    body: string;\r\n    \r\n    /** Custom permlink (auto-generated if not provided) */\r\n    permlink?: string;\r\n    \r\n    /** Post title (empty for comments/snaps) */\r\n    title?: string;\r\n    \r\n    /** Parent author (empty for top-level posts) */\r\n    parentAuthor: string;\r\n    \r\n    /** Parent permlink (community tag or container permlink) */\r\n    parentPermlink: string;\r\n    \r\n    /** Image URLs to append to body */\r\n    images?: string[];\r\n    \r\n    /** GIF URL to append to body */\r\n    gifUrl?: string;\r\n    \r\n    /** Video embed URL (3Speak, YouTube, etc.) */\r\n    videoEmbedUrl?: string;\r\n    \r\n    /** Audio embed URL */\r\n    audioEmbedUrl?: string;\r\n    \r\n    /** Custom tags (hashtags extracted automatically from body too) */\r\n    tags?: string[];\r\n    \r\n    /** Custom json_metadata fields */\r\n    metadata?: Record<string, unknown>;\r\n    \r\n    /** Beneficiaries for this post */\r\n    beneficiaries?: Beneficiary[];\r\n    \r\n    /** Max accepted payout (default: \"1000000.000 HBD\") */\r\n    maxAcceptedPayout?: string;\r\n    \r\n    /** Percent HBD (default: 10000 = 100%) */\r\n    percentHbd?: number;\r\n    \r\n    /** Allow votes (default: true) */\r\n    allowVotes?: boolean;\r\n    \r\n    /** Allow curation rewards (default: true) */\r\n    allowCurationRewards?: boolean;\r\n}\r\n\r\n/**\r\n * Result from building operations\r\n */\r\nexport interface ComposerResult {\r\n    /** The operations to broadcast */\r\n    operations: Operation[];\r\n    \r\n    /** The generated permlink */\r\n    permlink: string;\r\n    \r\n    /** The final body content */\r\n    body: string;\r\n    \r\n    /** The json_metadata object */\r\n    metadata: Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Configuration for the composer\r\n */\r\nexport interface ComposerConfig {\r\n    /** Application name for json_metadata (default: \"snapie\") */\r\n    appName?: string;\r\n    \r\n    /** Default tags to include in posts */\r\n    defaultTags?: string[];\r\n    \r\n    /** Default beneficiaries for all posts */\r\n    beneficiaries?: Beneficiary[];\r\n}\r\n\r\n// ============================================================================\r\n// Utilities\r\n// ============================================================================\r\n\r\n/**\r\n * Generate a unique permlink from current timestamp\r\n */\r\nexport function generatePermlink(): string {\r\n    return new Date()\r\n        .toISOString()\r\n        .replace(/[^a-zA-Z0-9]/g, \"\")\r\n        .toLowerCase();\r\n}\r\n\r\n/**\r\n * Extract hashtags from text content\r\n * \r\n * @param text - Text to extract hashtags from\r\n * @returns Array of hashtag strings (without the # symbol)\r\n */\r\nexport function extractHashtags(text: string): string[] {\r\n    const hashtagRegex = /#(\\w+)/g;\r\n    const matches = text.match(hashtagRegex) || [];\r\n    return matches.map(hashtag => hashtag.slice(1));\r\n}\r\n\r\n/**\r\n * Build markdown image syntax from URL\r\n */\r\nexport function imageToMarkdown(url: string): string {\r\n    return `![image](${url})`;\r\n}\r\n\r\n/**\r\n * Build markdown for multiple images\r\n */\r\nexport function imagesToMarkdown(urls: string[]): string {\r\n    return urls.map(imageToMarkdown).join('\\n');\r\n}\r\n\r\n/**\r\n * Append media embeds to body content\r\n */\r\nexport function appendMediaToBody(\r\n    body: string,\r\n    options: {\r\n        images?: string[];\r\n        gifUrl?: string;\r\n        videoEmbedUrl?: string;\r\n        audioEmbedUrl?: string;\r\n    }\r\n): string {\r\n    let result = body;\r\n    \r\n    if (options.videoEmbedUrl) {\r\n        result += `\\n\\n${options.videoEmbedUrl}`;\r\n    }\r\n    \r\n    if (options.audioEmbedUrl) {\r\n        result += `\\n\\n${options.audioEmbedUrl}`;\r\n    }\r\n    \r\n    if (options.images && options.images.length > 0) {\r\n        result += `\\n\\n${imagesToMarkdown(options.images)}`;\r\n    }\r\n    \r\n    if (options.gifUrl) {\r\n        result += `\\n\\n![gif](${options.gifUrl})`;\r\n    }\r\n    \r\n    return result;\r\n}\r\n\r\n// ============================================================================\r\n// Operation Builders\r\n// ============================================================================\r\n\r\n/**\r\n * Build a comment operation\r\n */\r\nexport function buildCommentOperation(input: {\r\n    parentAuthor: string;\r\n    parentPermlink: string;\r\n    author: string;\r\n    permlink: string;\r\n    title: string;\r\n    body: string;\r\n    metadata: Record<string, unknown>;\r\n}): CommentOperation {\r\n    return [\r\n        'comment',\r\n        {\r\n            parent_author: input.parentAuthor,\r\n            parent_permlink: input.parentPermlink,\r\n            author: input.author,\r\n            permlink: input.permlink,\r\n            title: input.title,\r\n            body: input.body,\r\n            json_metadata: JSON.stringify(input.metadata)\r\n        }\r\n    ];\r\n}\r\n\r\n/**\r\n * Build a comment_options operation (for beneficiaries, payout settings, etc.)\r\n */\r\nexport function buildCommentOptionsOperation(input: {\r\n    author: string;\r\n    permlink: string;\r\n    maxAcceptedPayout?: string;\r\n    percentHbd?: number;\r\n    allowVotes?: boolean;\r\n    allowCurationRewards?: boolean;\r\n    beneficiaries?: Beneficiary[];\r\n}): CommentOptionsOperation {\r\n    const extensions: [0, { beneficiaries: { account: string; weight: number }[] }][] = [];\r\n    \r\n    if (input.beneficiaries && input.beneficiaries.length > 0) {\r\n        // Sort beneficiaries alphabetically by account (required by Hive)\r\n        const sortedBeneficiaries = [...input.beneficiaries].sort((a, b) => \r\n            a.account.localeCompare(b.account)\r\n        );\r\n        \r\n        extensions.push([0, { beneficiaries: sortedBeneficiaries }]);\r\n    }\r\n    \r\n    return [\r\n        'comment_options',\r\n        {\r\n            author: input.author,\r\n            permlink: input.permlink,\r\n            max_accepted_payout: input.maxAcceptedPayout ?? '1000000.000 HBD',\r\n            percent_hbd: input.percentHbd ?? 10000,\r\n            allow_votes: input.allowVotes ?? true,\r\n            allow_curation_rewards: input.allowCurationRewards ?? true,\r\n            extensions\r\n        }\r\n    ];\r\n}\r\n\r\n// ============================================================================\r\n// Main Composer Factory\r\n// ============================================================================\r\n\r\n/**\r\n * Create a configured composer instance\r\n * \r\n * @example\r\n * ```typescript\r\n * import { createComposer } from '@snapie/operations';\r\n * \r\n * const composer = createComposer({\r\n *   appName: 'my-app',\r\n *   defaultTags: ['my-app'],\r\n *   beneficiaries: [{ account: 'my-app', weight: 500 }] // 5%\r\n * });\r\n * \r\n * const result = composer.build({\r\n *   author: 'user',\r\n *   body: 'Hello!',\r\n *   parentAuthor: '',\r\n *   parentPermlink: 'hive-123456'\r\n * });\r\n * \r\n * // Broadcast with any auth method\r\n * await myAuth.broadcast(result.operations);\r\n * ```\r\n */\r\nexport function createComposer(config: ComposerConfig = {}) {\r\n    const appName = config.appName ?? 'snapie';\r\n    const defaultTags = config.defaultTags ?? [];\r\n    const defaultBeneficiaries = config.beneficiaries ?? [];\r\n    \r\n    return {\r\n        /**\r\n         * Build operations for a comment/post\r\n         */\r\n        build(input: CommentInput): ComposerResult {\r\n            const permlink = input.permlink ?? generatePermlink();\r\n            \r\n            // Build body with media\r\n            const body = appendMediaToBody(input.body, {\r\n                images: input.images,\r\n                gifUrl: input.gifUrl,\r\n                videoEmbedUrl: input.videoEmbedUrl,\r\n                audioEmbedUrl: input.audioEmbedUrl\r\n            });\r\n            \r\n            // Extract and combine tags\r\n            const extractedTags = extractHashtags(body);\r\n            const allTags = [...new Set([\r\n                ...defaultTags,\r\n                ...(input.tags ?? []),\r\n                ...extractedTags\r\n            ])];\r\n            \r\n            // Build metadata\r\n            const metadata: Record<string, unknown> = {\r\n                app: appName,\r\n                tags: allTags,\r\n                ...(input.images && input.images.length > 0 ? { images: input.images } : {}),\r\n                ...input.metadata\r\n            };\r\n            \r\n            // Build comment operation\r\n            const commentOp = buildCommentOperation({\r\n                parentAuthor: input.parentAuthor,\r\n                parentPermlink: input.parentPermlink,\r\n                author: input.author,\r\n                permlink,\r\n                title: input.title ?? '',\r\n                body,\r\n                metadata\r\n            });\r\n            \r\n            const operations: Operation[] = [commentOp];\r\n            \r\n            // Determine if we need comment_options\r\n            const beneficiaries = input.beneficiaries ?? defaultBeneficiaries;\r\n            const hasBeneficiaries = beneficiaries.length > 0;\r\n            const hasCustomPayoutSettings = \r\n                input.maxAcceptedPayout !== undefined ||\r\n                input.percentHbd !== undefined ||\r\n                input.allowVotes !== undefined ||\r\n                input.allowCurationRewards !== undefined;\r\n            \r\n            if (hasBeneficiaries || hasCustomPayoutSettings) {\r\n                const optionsOp = buildCommentOptionsOperation({\r\n                    author: input.author,\r\n                    permlink,\r\n                    maxAcceptedPayout: input.maxAcceptedPayout,\r\n                    percentHbd: input.percentHbd,\r\n                    allowVotes: input.allowVotes,\r\n                    allowCurationRewards: input.allowCurationRewards,\r\n                    beneficiaries: hasBeneficiaries ? beneficiaries : undefined\r\n                });\r\n                \r\n                operations.push(optionsOp);\r\n            }\r\n            \r\n            return {\r\n                operations,\r\n                permlink,\r\n                body,\r\n                metadata\r\n            };\r\n        }\r\n    };\r\n}\r\n\r\n// Re-export dhive types for convenience\r\nexport type {\r\n    CommentOperation,\r\n    CommentOptionsOperation,\r\n    Operation\r\n} from '@hiveio/dhive';\r\n"],"mappings":"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","names":[]}