{"version":3,"sources":["../src/core.ts"],"sourcesContent":["/**\n * @snapie/operations - Core Module\n * \n * Core utilities for building Hive blockchain operations.\n * This module has no external dependencies beyond @hiveio/dhive types.\n */\n\nimport type { CommentOperation, CommentOptionsOperation, Operation } from '@hiveio/dhive';\n\n// ============================================================================\n// Types\n// ============================================================================\n\n/**\n * Beneficiary recipient for post rewards\n */\nexport interface Beneficiary {\n    account: string;\n    /** Weight in basis points (100 = 1%, 1000 = 10%, 10000 = 100%) */\n    weight: number;\n}\n\n/**\n * Input for building a comment/post operation\n */\nexport interface CommentInput {\n    /** Author's Hive username */\n    author: string;\n    \n    /** Post body in markdown */\n    body: string;\n    \n    /** Custom permlink (auto-generated if not provided) */\n    permlink?: string;\n    \n    /** Post title (empty for comments/snaps) */\n    title?: string;\n    \n    /** Parent author (empty for top-level posts) */\n    parentAuthor: string;\n    \n    /** Parent permlink (community tag or container permlink) */\n    parentPermlink: string;\n    \n    /** Image URLs to append to body */\n    images?: string[];\n    \n    /** GIF URL to append to body */\n    gifUrl?: string;\n    \n    /** Video embed URL (3Speak, YouTube, etc.) */\n    videoEmbedUrl?: string;\n    \n    /** Audio embed URL */\n    audioEmbedUrl?: string;\n    \n    /** Custom tags (hashtags extracted automatically from body too) */\n    tags?: string[];\n    \n    /** Custom json_metadata fields */\n    metadata?: Record<string, unknown>;\n    \n    /** Beneficiaries for this post */\n    beneficiaries?: Beneficiary[];\n    \n    /** Max accepted payout (default: \"1000000.000 HBD\") */\n    maxAcceptedPayout?: string;\n    \n    /** Percent HBD (default: 10000 = 100%) */\n    percentHbd?: number;\n    \n    /** Allow votes (default: true) */\n    allowVotes?: boolean;\n    \n    /** Allow curation rewards (default: true) */\n    allowCurationRewards?: boolean;\n}\n\n/**\n * Result from building operations\n */\nexport interface ComposerResult {\n    /** The operations to broadcast */\n    operations: Operation[];\n    \n    /** The generated permlink */\n    permlink: string;\n    \n    /** The final body content */\n    body: string;\n    \n    /** The json_metadata object */\n    metadata: Record<string, unknown>;\n}\n\n/**\n * Configuration for the composer\n */\nexport interface ComposerConfig {\n    /** Application name for json_metadata (default: \"snapie\") */\n    appName?: string;\n    \n    /** Default tags to include in posts */\n    defaultTags?: string[];\n    \n    /** Default beneficiaries for all posts */\n    beneficiaries?: Beneficiary[];\n}\n\n// ============================================================================\n// Utilities\n// ============================================================================\n\n/**\n * Generate a unique permlink from current timestamp\n */\nexport function generatePermlink(): string {\n    return new Date()\n        .toISOString()\n        .replace(/[^a-zA-Z0-9]/g, \"\")\n        .toLowerCase();\n}\n\n/**\n * Extract hashtags from text content\n * \n * @param text - Text to extract hashtags from\n * @returns Array of hashtag strings (without the # symbol)\n */\nexport function extractHashtags(text: string): string[] {\n    const hashtagRegex = /#(\\w+)/g;\n    const matches = text.match(hashtagRegex) || [];\n    return matches.map(hashtag => hashtag.slice(1));\n}\n\n/**\n * Build markdown image syntax from URL\n */\nexport function imageToMarkdown(url: string): string {\n    return `![image](${url})`;\n}\n\n/**\n * Build markdown for multiple images\n */\nexport function imagesToMarkdown(urls: string[]): string {\n    return urls.map(imageToMarkdown).join('\\n');\n}\n\n/**\n * Append media embeds to body content\n */\nexport function appendMediaToBody(\n    body: string,\n    options: {\n        images?: string[];\n        gifUrl?: string;\n        videoEmbedUrl?: string;\n        audioEmbedUrl?: string;\n    }\n): string {\n    let result = body;\n    \n    if (options.videoEmbedUrl) {\n        result += `\\n\\n${options.videoEmbedUrl}`;\n    }\n    \n    if (options.audioEmbedUrl) {\n        result += `\\n\\n${options.audioEmbedUrl}`;\n    }\n    \n    if (options.images && options.images.length > 0) {\n        result += `\\n\\n${imagesToMarkdown(options.images)}`;\n    }\n    \n    if (options.gifUrl) {\n        result += `\\n\\n![gif](${options.gifUrl})`;\n    }\n    \n    return result;\n}\n\n// ============================================================================\n// Operation Builders\n// ============================================================================\n\n/**\n * Build a comment operation\n */\nexport function buildCommentOperation(input: {\n    parentAuthor: string;\n    parentPermlink: string;\n    author: string;\n    permlink: string;\n    title: string;\n    body: string;\n    metadata: Record<string, unknown>;\n}): CommentOperation {\n    return [\n        'comment',\n        {\n            parent_author: input.parentAuthor,\n            parent_permlink: input.parentPermlink,\n            author: input.author,\n            permlink: input.permlink,\n            title: input.title,\n            body: input.body,\n            json_metadata: JSON.stringify(input.metadata)\n        }\n    ];\n}\n\n/**\n * Build a comment_options operation (for beneficiaries, payout settings, etc.)\n */\nexport function buildCommentOptionsOperation(input: {\n    author: string;\n    permlink: string;\n    maxAcceptedPayout?: string;\n    percentHbd?: number;\n    allowVotes?: boolean;\n    allowCurationRewards?: boolean;\n    beneficiaries?: Beneficiary[];\n}): CommentOptionsOperation {\n    const extensions: [0, { beneficiaries: { account: string; weight: number }[] }][] = [];\n    \n    if (input.beneficiaries && input.beneficiaries.length > 0) {\n        // Sort beneficiaries alphabetically by account (required by Hive)\n        const sortedBeneficiaries = [...input.beneficiaries].sort((a, b) => \n            a.account.localeCompare(b.account)\n        );\n        \n        extensions.push([0, { beneficiaries: sortedBeneficiaries }]);\n    }\n    \n    return [\n        'comment_options',\n        {\n            author: input.author,\n            permlink: input.permlink,\n            max_accepted_payout: input.maxAcceptedPayout ?? '1000000.000 HBD',\n            percent_hbd: input.percentHbd ?? 10000,\n            allow_votes: input.allowVotes ?? true,\n            allow_curation_rewards: input.allowCurationRewards ?? true,\n            extensions\n        }\n    ];\n}\n\n// ============================================================================\n// Main Composer Factory\n// ============================================================================\n\n/**\n * Create a configured composer instance\n * \n * @example\n * ```typescript\n * import { createComposer } from '@snapie/operations';\n * \n * const composer = createComposer({\n *   appName: 'my-app',\n *   defaultTags: ['my-app'],\n *   beneficiaries: [{ account: 'my-app', weight: 500 }] // 5%\n * });\n * \n * const result = composer.build({\n *   author: 'user',\n *   body: 'Hello!',\n *   parentAuthor: '',\n *   parentPermlink: 'hive-123456'\n * });\n * \n * // Broadcast with any auth method\n * await myAuth.broadcast(result.operations);\n * ```\n */\nexport function createComposer(config: ComposerConfig = {}) {\n    const appName = config.appName ?? 'snapie';\n    const defaultTags = config.defaultTags ?? [];\n    const defaultBeneficiaries = config.beneficiaries ?? [];\n    \n    return {\n        /**\n         * Build operations for a comment/post\n         */\n        build(input: CommentInput): ComposerResult {\n            const permlink = input.permlink ?? generatePermlink();\n            \n            // Build body with media\n            const body = appendMediaToBody(input.body, {\n                images: input.images,\n                gifUrl: input.gifUrl,\n                videoEmbedUrl: input.videoEmbedUrl,\n                audioEmbedUrl: input.audioEmbedUrl\n            });\n            \n            // Extract and combine tags\n            const extractedTags = extractHashtags(body);\n            const allTags = [...new Set([\n                ...defaultTags,\n                ...(input.tags ?? []),\n                ...extractedTags\n            ])];\n            \n            // Build metadata\n            const metadata: Record<string, unknown> = {\n                app: appName,\n                tags: allTags,\n                ...(input.images && input.images.length > 0 ? { images: input.images } : {}),\n                ...input.metadata\n            };\n            \n            // Build comment operation\n            const commentOp = buildCommentOperation({\n                parentAuthor: input.parentAuthor,\n                parentPermlink: input.parentPermlink,\n                author: input.author,\n                permlink,\n                title: input.title ?? '',\n                body,\n                metadata\n            });\n            \n            const operations: Operation[] = [commentOp];\n            \n            // Determine if we need comment_options\n            const beneficiaries = input.beneficiaries ?? defaultBeneficiaries;\n            const hasBeneficiaries = beneficiaries.length > 0;\n            const hasCustomPayoutSettings = \n                input.maxAcceptedPayout !== undefined ||\n                input.percentHbd !== undefined ||\n                input.allowVotes !== undefined ||\n                input.allowCurationRewards !== undefined;\n            \n            if (hasBeneficiaries || hasCustomPayoutSettings) {\n                const optionsOp = buildCommentOptionsOperation({\n                    author: input.author,\n                    permlink,\n                    maxAcceptedPayout: input.maxAcceptedPayout,\n                    percentHbd: input.percentHbd,\n                    allowVotes: input.allowVotes,\n                    allowCurationRewards: input.allowCurationRewards,\n                    beneficiaries: hasBeneficiaries ? beneficiaries : undefined\n                });\n                \n                operations.push(optionsOp);\n            }\n            \n            return {\n                operations,\n                permlink,\n                body,\n                metadata\n            };\n        }\n    };\n}\n\n// Re-export dhive types for convenience\nexport type {\n    CommentOperation,\n    CommentOptionsOperation,\n    Operation\n} from '@hiveio/dhive';\n"],"mappings":"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","names":[]}