{"version":3,"sources":["../src/index.ts"],"sourcesContent":["/**\r\n * @snapie/renderer\r\n * \r\n * A configurable Hive blockchain markdown renderer with support for:\r\n * - 3Speak video/audio embeds\r\n * - IPFS content handling\r\n * - Hive frontend URL conversion\r\n * - XSS protection via DOMPurify\r\n */\r\n\r\nimport { DefaultRenderer } from \"@hiveio/content-renderer\";\r\nimport DOMPurify from 'isomorphic-dompurify';\r\n\r\n/**\r\n * Configuration options for the Hive markdown renderer\r\n */\r\nexport interface HiveRendererOptions {\n    /** Base URL for relative links (default: \"https://hive.blog/\") */\r\n    baseUrl?: string;\r\n    \r\n    /** \r\n     * Primary IPFS gateway URL (default: \"https://ipfs.3speak.tv\")\r\n     * This is used for rendering IPFS content\r\n     */\r\n    ipfsGateway?: string;\r\n    \r\n    /**\r\n     * Fallback IPFS gateways to try if primary fails\r\n     * Default: [\"https://ipfs.skatehive.app\", \"https://cloudflare-ipfs.com\", \"https://ipfs.io\"]\r\n     */\r\n    ipfsFallbackGateways?: string[];\r\n    \r\n    /** Function to transform user mentions to URLs (default: (account) => \"/@\" + account) */\r\n    usertagUrlFn?: (account: string) => string;\r\n    \r\n    /** Function to transform hashtags to URLs (default: (hashtag) => \"/trending/\" + hashtag) */\r\n    hashtagUrlFn?: (hashtag: string) => string;\r\n    \r\n    /** Additional Hive frontends to recognize for URL conversion */\r\n    additionalHiveFrontends?: string[];\r\n    \r\n    /** Whether to convert Hive frontend URLs to internal links (default: true) */\r\n    convertHiveUrls?: boolean;\r\n    \r\n    /** Internal URL prefix for converted Hive links (default: \"\") - e.g., \"\" produces \"/@author/permlink\" */\r\n    internalUrlPrefix?: string;\r\n    \r\n    /** Asset dimensions */\r\n    assetsWidth?: number;\r\n    assetsHeight?: number;\r\n    \r\n    /** Custom image proxy function */\n    imageProxyFn?: (url: string) => string;\n\n    /** Enable rendering :emoji: tokens as Hivemoji images (default: false) */\n    enableHivemoji?: boolean;\n\n    /** Base URL for the Hivemoji API (default: \"https://hivemoji.hivelytics.io\") */\n    hivemojiBaseUrl?: string;\n\n    /** Fallback owner for :emoji: tokens when no owner is provided */\n    hivemojiDefaultOwner?: string;\n}\n\n/**\n * Per-render context options\n */\nexport interface HiveRendererContext {\n    /** Default owner to resolve :emoji: tokens (usually the post author) */\n    defaultEmojiOwner?: string;\n}\n\r\n/**\r\n * Default IPFS gateways in order of preference\r\n * 3Speak is primary since it's optimized for Hive content\r\n */\r\nconst DEFAULT_IPFS_GATEWAY = \"https://ipfs.3speak.tv\";\nconst DEFAULT_IPFS_FALLBACKS = [\n    \"https://ipfs.skatehive.app\",\n    \"https://cloudflare-ipfs.com\",\n    \"https://ipfs.io\"\n];\nconst DEFAULT_HIVEMOJI_BASE_URL = \"https://hivemoji.hivelytics.io\";\nconst HIVEMOJI_REGEX = /:([a-z0-9._-]+\\/)?([a-z0-9._-]{1,32}):/gi;\nconst HIVEMOJI_SKIP_TAGS = new Set([\n    'script',\n    'style',\n    'textarea',\n    'code',\n    'pre',\n    'kbd',\n    'samp'\n]);\n\r\n/**\r\n * Default Hive frontends recognized for URL conversion\r\n */\r\nconst DEFAULT_HIVE_FRONTENDS = [\r\n    'peakd.com',\r\n    'ecency.com',\r\n    'hive.blog',\r\n    'hiveblog.io',\r\n    'leofinance.io',\r\n    '3speak.tv',\r\n    'd.tube',\r\n    'esteem.app',\r\n    'busy.org'\r\n];\r\n\r\n/**\r\n * DOMPurify configuration for safe HTML output\r\n */\r\nconst DOMPURIFY_CONFIG = {\r\n    ALLOWED_TAGS: [\r\n        // Text formatting\r\n        'p', 'br', 'span', 'div', 'blockquote', 'pre', 'code',\r\n        'strong', 'em', 'b', 'i', 'u', 'ins', 'del', 's', 'strike',\r\n        'mark', 'sub', 'sup', 'small',\r\n        // Headings\r\n        'h1', 'h2', 'h3', 'h4', 'h5', 'h6',\r\n        // Lists\r\n        'ul', 'ol', 'li', 'dl', 'dt', 'dd',\r\n        // Tables\r\n        'table', 'thead', 'tbody', 'tfoot', 'tr', 'th', 'td', 'caption', 'col', 'colgroup',\r\n        // Links and media\r\n        'a', 'img', 'video', 'source', 'audio', 'iframe',\r\n        // Other safe elements\r\n        'hr', 'center', 'details', 'summary'\r\n    ],\r\n    ALLOWED_ATTR: [\r\n        'href', 'src', 'alt', 'title', 'width', 'height',\r\n        'class', 'id', 'style', 'target', 'rel',\r\n        'controls', 'muted', 'preload', 'loading', 'autoplay', 'loop',\r\n        'type', 'allowfullscreen', 'frameborder', 'allow', 'scrolling',\r\n        'colspan', 'rowspan', 'align', 'valign',\r\n        'start', 'reversed',\r\n        'data-dnt', 'data-theme', 'allowtransparency'\r\n    ],\r\n    ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|ipfs):|[^a-z]|[a-z+.\\-]+(?:[^a-z+.\\-:]|$))/i,\r\n    ALLOW_DATA_ATTR: false,\r\n    ALLOW_UNKNOWN_PROTOCOLS: false,\r\n    FORBID_TAGS: ['script', 'form', 'input', 'button', 'textarea', 'select', 'dialog', 'object', 'embed', 'applet', 'base', 'link', 'meta'],\r\n    FORBID_ATTR: ['onerror', 'onload', 'onclick', 'onmouseover', 'onmouseout', 'onmousemove', 'onmouseenter', 'onmouseleave', 'onfocus', 'onblur', 'onchange', 'onsubmit', 'onkeydown', 'onkeyup', 'onkeypress'],\r\n    KEEP_CONTENT: true,\r\n    RETURN_TRUSTED_TYPE: false\r\n};\r\n\r\n/**\r\n * Fix malformed center tags from DefaultRenderer\r\n * DefaultRenderer sometimes produces: <p><center>...content...<hr />...more content...</center></p>\r\n */\r\nfunction fixMalformedCenterTags(content: string): string {\r\n    return content.replace(\r\n        /<p><center>([\\s\\S]*?)<hr \\/>([\\s\\S]*?)<\\/center><\\/p>/gi,\r\n        (match, beforeHr, afterHr) => {\r\n            return `<center>${beforeHr.trim()}</center><hr />${afterHr.trim()}`;\r\n        }\r\n    );\r\n}\r\n\r\n/**\r\n * Transform 3Speak URLs to embedded iframes\r\n * Handles both legacy (3speak.tv) and current (play.3speak.tv) URLs\r\n * Deduplicates multiple instances of the same video\r\n */\r\nfunction transform3SpeakContent(content: string): string {\r\n    const embeddedVideos = new Set<string>();\r\n    const embeddedAudios = new Set<string>();\r\n\r\n    // Fix malformed center tags first\r\n    content = fixMalformedCenterTags(content);\r\n\r\n    // Handle LEGACY 3speak.tv URLs (without play. subdomain)\r\n    content = content.replace(\r\n        /<a[^>]*href=\"(https?:\\/\\/3speak\\.tv\\/watch\\?v=([^\"&]+)[^\"]*)\"[^>]*>.*?<\\/a>/g,\r\n        (match, fullUrl, videoId) => {\r\n            if (embeddedVideos.has(videoId)) return match;\r\n            embeddedVideos.add(videoId);\r\n            const embedUrl = `https://play.3speak.tv/watch?v=${videoId}&mode=iframe`;\r\n            return `<div class=\"video-container\"><iframe src=\"${embedUrl}\" allowfullscreen loading=\"lazy\"></iframe></div>`;\r\n        }\r\n    );\r\n\r\n    // Handle 3Speak watch URLs (with play. subdomain)\r\n    content = content.replace(\r\n        /<a[^>]*href=\"(https?:\\/\\/play\\.3speak\\.tv\\/watch\\?v=([^\"&]+)[^\"]*)\"[^>]*>.*?<\\/a>/g,\r\n        (match, fullUrl, videoId) => {\r\n            if (embeddedVideos.has(videoId)) return match;\r\n            embeddedVideos.add(videoId);\r\n            const embedUrl = `https://play.3speak.tv/watch?v=${videoId}&mode=iframe`;\r\n            return `<div class=\"video-container\"><iframe src=\"${embedUrl}\" allowfullscreen loading=\"lazy\"></iframe></div>`;\r\n        }\r\n    );\r\n\r\n    // Handle 3Speak embed URLs\r\n    content = content.replace(\r\n        /<a[^>]*href=\"(https?:\\/\\/play\\.3speak\\.tv\\/embed\\?v=([^\"&]+)[^\"]*)\"[^>]*>.*?<\\/a>/g,\r\n        (match, fullUrl, videoId) => {\r\n            if (embeddedVideos.has(videoId)) return match;\r\n            embeddedVideos.add(videoId);\r\n            const embedUrl = `https://play.3speak.tv/embed?v=${videoId}&mode=iframe`;\r\n            return `<div class=\"video-container\"><iframe src=\"${embedUrl}\" allowfullscreen loading=\"lazy\"></iframe></div>`;\r\n        }\r\n    );\r\n\r\n    // Handle 3Speak audio URLs\r\n    content = content.replace(\r\n        /<a[^>]*href=\"(https?:\\/\\/audio\\.3speak\\.tv\\/play\\?a=([^\"&]+)[^\"]*)\"[^>]*>.*?<\\/a>/g,\r\n        (match, fullUrl, audioId) => {\r\n            if (embeddedAudios.has(audioId)) return match;\r\n            embeddedAudios.add(audioId);\r\n            const embedUrl = `https://audio.3speak.tv/play?a=${audioId}`;\r\n            return `<div class=\"audio-container\"><iframe src=\"${embedUrl}\" loading=\"lazy\"></iframe></div>`;\r\n        }\r\n    );\r\n\r\n    return content;\r\n}\r\n\r\n/**\r\n * Transform Twitter/X URLs to embedded tweets\r\n * Handles both twitter.com and x.com domains\r\n * Uses iframe embed for security (no external scripts)\r\n */\r\nfunction transformTwitterContent(content: string): string {\r\n    const embeddedTweets = new Set<string>();\r\n\r\n    // Match Twitter/X URLs in anchor tags: twitter.com/user/status/ID or x.com/user/status/ID\r\n    const twitterRegex = /<a[^>]*href=\"(https?:\\/\\/(?:twitter\\.com|x\\.com)\\/([^/]+)\\/status\\/(\\d+)[^\"]*)\"[^>]*>.*?<\\/a>/gi;\r\n    \r\n    content = content.replace(twitterRegex, (match, fullUrl, username, tweetId) => {\r\n        if (embeddedTweets.has(tweetId)) return match;\r\n        embeddedTweets.add(tweetId);\r\n        \r\n        // Use syndication iframe embed (no script required)\r\n        return `<div class=\"twitter-embed-container\" style=\"max-width: 550px;\">\r\n            <iframe \r\n                src=\"https://platform.twitter.com/embed/Tweet.html?id=${tweetId}&dnt=true\" \r\n                width=\"550\" \r\n                height=\"250\" \r\n                frameborder=\"0\" \r\n                scrolling=\"no\" \r\n                allowtransparency=\"true\"\r\n                loading=\"lazy\"\r\n                style=\"border: 1px solid #ccc; border-radius: 12px;\">\r\n            </iframe>\r\n        </div>`;\r\n    });\r\n\r\n    // Also handle plain URLs (not in anchor tags) - commonly pasted directly\r\n    const plainTwitterRegex = /(?<![\">])(https?:\\/\\/(?:twitter\\.com|x\\.com)\\/([^/\\s]+)\\/status\\/(\\d+))(?![^<]*<\\/a>)/gi;\r\n    \r\n    content = content.replace(plainTwitterRegex, (match, fullUrl, username, tweetId) => {\r\n        if (embeddedTweets.has(tweetId)) return match;\r\n        embeddedTweets.add(tweetId);\r\n        \r\n        return `<div class=\"twitter-embed-container\" style=\"max-width: 550px;\">\r\n            <iframe \r\n                src=\"https://platform.twitter.com/embed/Tweet.html?id=${tweetId}&dnt=true\" \r\n                width=\"550\" \r\n                height=\"250\" \r\n                frameborder=\"0\" \r\n                scrolling=\"no\" \r\n                allowtransparency=\"true\"\r\n                loading=\"lazy\"\r\n                style=\"border: 1px solid #ccc; border-radius: 12px;\">\r\n            </iframe>\r\n        </div>`;\r\n    });\r\n\r\n    return content;\r\n}\r\n\r\n/**\r\n * Transform Instagram URLs to embedded posts\r\n * Handles posts, reels, and stories\r\n */\r\nfunction transformInstagramContent(content: string): string {\r\n    const embeddedPosts = new Set<string>();\r\n\r\n    // Match Instagram URLs in anchor tags: instagram.com/p/CODE/ or instagram.com/reel/CODE/\r\n    const instagramRegex = /<a[^>]*href=\"(https?:\\/\\/(?:www\\.)?instagram\\.com\\/(?:p|reel|tv)\\/([a-zA-Z0-9_-]+)[^\"]*)\"[^>]*>.*?<\\/a>/gi;\r\n    \r\n    content = content.replace(instagramRegex, (match, fullUrl, postCode) => {\r\n        if (embeddedPosts.has(postCode)) return match;\r\n        embeddedPosts.add(postCode);\r\n        \r\n        // Use Instagram's embed iframe\r\n        return `<div class=\"instagram-embed-container\">\r\n            <iframe \r\n                src=\"https://www.instagram.com/p/${postCode}/embed\" \r\n                width=\"400\" \r\n                height=\"480\" \r\n                frameborder=\"0\" \r\n                scrolling=\"no\" \r\n                allowtransparency=\"true\"\r\n                loading=\"lazy\">\r\n            </iframe>\r\n        </div>`;\r\n    });\r\n\r\n    // Also handle plain URLs (not in anchor tags)\r\n    const plainInstagramRegex = /(?<![\">])(https?:\\/\\/(?:www\\.)?instagram\\.com\\/(?:p|reel|tv)\\/([a-zA-Z0-9_-]+)[^\\s<]*)(?![^<]*<\\/a>)/gi;\r\n    \r\n    content = content.replace(plainInstagramRegex, (match, fullUrl, postCode) => {\r\n        if (embeddedPosts.has(postCode)) return match;\r\n        embeddedPosts.add(postCode);\r\n        \r\n        return `<div class=\"instagram-embed-container\">\r\n            <iframe \r\n                src=\"https://www.instagram.com/p/${postCode}/embed\" \r\n                width=\"400\" \r\n                height=\"480\" \r\n                frameborder=\"0\" \r\n                scrolling=\"no\" \r\n                allowtransparency=\"true\"\r\n                loading=\"lazy\">\r\n            </iframe>\r\n        </div>`;\r\n    });\r\n\r\n    return content;\r\n}\r\n\r\n/**\r\n * Transform IPFS iframes to native video elements with fallback sources\r\n */\r\nfunction transformIPFSContent(\r\n    content: string, \r\n    ipfsGateway: string,\r\n    fallbackGateways: string[]\r\n): string {\r\n    // Match IPFS iframes from various gateways\r\n    const ipfsGatewayPatterns = [ipfsGateway, ...fallbackGateways, 'https://ipfs.io', 'https://gateway.pinata.cloud'];\r\n    \r\n    for (const gateway of ipfsGatewayPatterns) {\r\n        const regex = new RegExp(\r\n            `<iframe src=\"${gateway.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')}/ipfs/([a-zA-Z0-9-?=&]+)\"(?:(?!<\\\\/iframe>).)*\\\\sallowfullscreen><\\\\/iframe>`,\r\n            'g'\r\n        );\r\n        \r\n        content = content.replace(regex, (match, videoID) => {\r\n            // Create video element with multiple source fallbacks\r\n            const sources = [ipfsGateway, ...fallbackGateways]\r\n                .map(gw => `<source src=\"${gw}/ipfs/${videoID}\" type=\"video/mp4\">`)\r\n                .join('\\n                    ');\r\n            \r\n            return `<video controls muted preload=\"none\" loading=\"lazy\"> \r\n                    ${sources}\r\n                </video>`;\r\n        });\r\n    }\r\n    \r\n    return content;\r\n}\r\n\r\n/**\r\n * Add safety attributes to IPFS links to prevent unwanted downloads\r\n */\r\nfunction preventIPFSDownloads(content: string): string {\n    return content.replace(\r\n        /<a href=\"(https?:\\/\\/[^\"]*(?:ipfs|bafy|Qm)[^\"]*)\"([^>]*)>/gi,\r\n        '<a href=\"$1\" target=\"_blank\" rel=\"noopener noreferrer\"$2 onclick=\"event.preventDefault(); window.open(this.href, \\'_blank\\'); return false;\">'\r\n    );\r\n}\n\nfunction normalizeHivemojiOwner(owner?: string | null): string | null {\n    if (!owner) return null;\n    const normalized = String(owner).replace(/^@/, '').trim();\n    return normalized.length > 0 ? normalized : null;\n}\n\nfunction buildHivemojiUrl(baseUrl: string, owner: string, name: string): string {\n    return `${baseUrl}/@${encodeURIComponent(owner)}/@${encodeURIComponent(name)}`;\n}\n\nfunction createHivemojiElement(\n    doc: Document,\n    baseUrl: string,\n    owner: string,\n    name: string,\n    altText: string\n): HTMLSpanElement {\n    const span = doc.createElement('span');\n    span.className = 'hivemoji';\n    span.setAttribute('role', 'img');\n    span.setAttribute('aria-label', altText);\n    const text = doc.createElement('span');\n    text.className = 'hivemoji__text';\n    text.textContent = altText;\n    text.style.display = 'none';\n\n    const img = doc.createElement('img');\n    img.className = 'hivemoji__img';\n    img.setAttribute('src', buildHivemojiUrl(baseUrl, owner, name));\n    img.setAttribute('alt', '');\n    img.setAttribute('aria-hidden', 'true');\n    img.setAttribute('loading', 'lazy');\n    img.setAttribute('decoding', 'async');\n    img.style.display = 'inline-block';\n    img.style.width = '1em';\n    img.style.height = '1em';\n    img.style.maxWidth = 'none';\n    img.style.maxHeight = 'none';\n    img.style.margin = '0';\n    img.style.objectFit = 'contain';\n    img.style.verticalAlign = 'middle';\n    img.setAttribute(\n        'onerror',\n        'this.style.display=\"none\";var p=this.parentElement;if(p){p.classList.add(\"hivemoji--fallback\");var t=p.querySelector(\".hivemoji__text\");if(t){t.style.display=\"inline\";}}'\n    );\n    span.style.display = 'inline-flex';\n    span.style.alignItems = 'center';\n    span.style.verticalAlign = 'middle';\n    span.style.margin = '0 0.05em';\n    span.append(text, img);\n    return span;\n}\n\nfunction transformHivemojiContent(\n    content: string,\n    options: { baseUrl: string; defaultOwner?: string | null }\n): string {\n    if (!content || !content.includes(':')) {\n        return DOMPurify.sanitize(content, DOMPURIFY_CONFIG);\n    }\n    HIVEMOJI_REGEX.lastIndex = 0;\n    if (!HIVEMOJI_REGEX.test(content)) {\n        HIVEMOJI_REGEX.lastIndex = 0;\n        return DOMPurify.sanitize(content, DOMPURIFY_CONFIG);\n    }\n    HIVEMOJI_REGEX.lastIndex = 0;\n\n    const fragment = DOMPurify.sanitize(content, {\n        ...DOMPURIFY_CONFIG,\n        RETURN_DOM_FRAGMENT: true\n    }) as DocumentFragment;\n    const doc = fragment.ownerDocument;\n    const root = fragment;\n\n    if (!doc) {\n        return DOMPurify.sanitize(content, DOMPURIFY_CONFIG);\n    }\n\n    const showText = doc.defaultView?.NodeFilter?.SHOW_TEXT ?? 4;\n    const walker = doc.createTreeWalker(root, showText);\n    const nodes: Text[] = [];\n\n    while (walker.nextNode()) {\n        nodes.push(walker.currentNode as Text);\n    }\n\n    const defaultOwner = normalizeHivemojiOwner(options.defaultOwner);\n\n    for (const node of nodes) {\n        const text = node.nodeValue;\n        if (!text || !text.includes(':')) continue;\n\n        const parent = node.parentElement;\n        if (!parent) continue;\n        if (HIVEMOJI_SKIP_TAGS.has(parent.tagName.toLowerCase())) continue;\n\n        let changed = false;\n        let lastIndex = 0;\n        HIVEMOJI_REGEX.lastIndex = 0;\n        const frag = doc.createDocumentFragment();\n\n        for (const match of text.matchAll(HIVEMOJI_REGEX)) {\n            const [full, ownerPart, name] = match;\n            const ownerCandidate = ownerPart ? ownerPart.slice(0, -1) : defaultOwner;\n            const owner = normalizeHivemojiOwner(ownerCandidate);\n            if (!owner) continue;\n\n            const index = match.index ?? 0;\n            const before = text.slice(lastIndex, index);\n            if (before) {\n                frag.append(doc.createTextNode(before));\n            }\n\n            frag.append(createHivemojiElement(doc, options.baseUrl, owner, name, full));\n            lastIndex = index + full.length;\n            changed = true;\n        }\n\n        if (!changed) continue;\n\n        const tail = text.slice(lastIndex);\n        if (tail) {\n            frag.append(doc.createTextNode(tail));\n        }\n\n        node.replaceWith(frag);\n    }\n\n    const container = doc.createElement('div');\n    container.appendChild(fragment);\n    return container.innerHTML;\n}\n\r\n/**\r\n * Convert Hive frontend URLs to internal app links\r\n */\r\nfunction convertHiveUrlsToInternal(\r\n    content: string, \r\n    hiveFrontends: string[], \r\n    internalPrefix: string\r\n): string {\r\n    const frontendsPattern = hiveFrontends.map(domain => domain.replace('.', '\\\\.')).join('|');\r\n    \r\n    const hiveUrlRegex = new RegExp(\r\n        `<a href=\"https?:\\\\/\\\\/(?:www\\\\.)?(${frontendsPattern})\\\\/((?:[^/]+\\\\/)?@([a-z0-9.-]+)\\\\/([a-z0-9-]+))\"([^>]*)>`,\r\n        'gi'\r\n    );\r\n    \r\n    return content.replace(hiveUrlRegex, (match, frontend, fullPath, author, permlink, attributes) => {\r\n        const internalUrl = `${internalPrefix}/@${author}/${permlink}`;\r\n        return `<a href=\"${internalUrl}\"${attributes}>`;\r\n    });\r\n}\r\n\r\n/**\r\n * Create a Hive markdown renderer with the given options\r\n * \r\n * @param options - Configuration options for the renderer\r\n * @returns A function that renders markdown to HTML\r\n * \r\n * @example\r\n * ```typescript\r\n * import { createHiveRenderer } from '@snapie/renderer';\r\n * \r\n * const render = createHiveRenderer({\r\n *   ipfsGateway: 'https://ipfs.3speak.tv',\r\n *   additionalHiveFrontends: ['myapp.io']\r\n * });\r\n * \r\n * const html = render(markdownContent);\r\n * ```\r\n */\r\nexport function createHiveRenderer(options: HiveRendererOptions = {}) {\n    const {\r\n        baseUrl = \"https://hive.blog/\",\r\n        ipfsGateway = DEFAULT_IPFS_GATEWAY,\r\n        ipfsFallbackGateways = DEFAULT_IPFS_FALLBACKS,\r\n        usertagUrlFn = (account: string) => \"/@\" + account,\r\n        hashtagUrlFn = (hashtag: string) => \"/trending/\" + hashtag,\r\n        additionalHiveFrontends = [],\r\n        convertHiveUrls = true,\r\n        internalUrlPrefix = \"\",\n        assetsWidth = 540,\n        assetsHeight = 380,\n        imageProxyFn,\n        enableHivemoji = false,\n        hivemojiBaseUrl = DEFAULT_HIVEMOJI_BASE_URL,\n        hivemojiDefaultOwner,\n    } = options;\n\r\n    const hiveFrontends = [...DEFAULT_HIVE_FRONTENDS, ...additionalHiveFrontends];\r\n\r\n    const defaultImageProxy = (url: string) => {\r\n        try {\r\n            if (url.includes('ipfs')) {\r\n                const parts = url.split('/ipfs/');\r\n                if (parts[1]) {\r\n                    return `https://ipfs.io/ipfs/${parts[1]}`;\r\n                }\r\n            }\r\n            return url;\r\n        } catch {\r\n            return url;\r\n        }\r\n    };\r\n\r\n    const renderer = new DefaultRenderer({\r\n        baseUrl,\r\n        breaks: true,\r\n        skipSanitization: false,\r\n        allowInsecureScriptTags: false,\r\n        addNofollowToLinks: true,\r\n        doNotShowImages: false,\r\n        assetsWidth,\r\n        assetsHeight,\r\n        imageProxyFn: imageProxyFn || defaultImageProxy,\r\n        usertagUrlFn,\r\n        hashtagUrlFn,\r\n        isLinkSafeFn: () => true,\r\n        addExternalCssClassToMatchingLinksFn: () => true,\r\n        ipfsPrefix: ipfsGateway\r\n    });\r\n\r\n    return function renderHiveMarkdown(markdown: string, context: HiveRendererContext = {}): string {\n        let html = renderer.render(markdown);\n        \r\n        // Transform 3Speak video/audio URLs to iframes\r\n        html = transform3SpeakContent(html);\r\n        \r\n        // Transform IPFS iframes to video tags with fallback sources\r\n        html = transformIPFSContent(html, ipfsGateway, ipfsFallbackGateways);\r\n        \r\n        // Transform Twitter/X URLs to embeds\r\n        html = transformTwitterContent(html);\r\n        \r\n        // Transform Instagram URLs to embeds\r\n        html = transformInstagramContent(html);\r\n        \r\n        // Prevent direct IPFS links from triggering downloads\r\n        html = preventIPFSDownloads(html);\r\n        \r\n        // Convert Hive frontend URLs to internal links\r\n        if (convertHiveUrls) {\n            html = convertHiveUrlsToInternal(html, hiveFrontends, internalUrlPrefix);\n        }\n\n        if (enableHivemoji) {\n            const defaultEmojiOwner = context.defaultEmojiOwner || hivemojiDefaultOwner;\n            return transformHivemojiContent(html, {\n                baseUrl: hivemojiBaseUrl,\n                defaultOwner: defaultEmojiOwner\n            });\n        }\n\n        // Sanitize with DOMPurify to prevent XSS attacks\n        return DOMPurify.sanitize(html, DOMPURIFY_CONFIG);\n    };\n}\n\r\n/**\r\n * Default renderer instance with standard configuration\r\n * \r\n * @example\r\n * ```typescript\r\n * import { renderHiveMarkdown } from '@snapie/renderer';\r\n * \r\n * const html = renderHiveMarkdown(markdownContent);\r\n * ```\r\n */\r\nexport const renderHiveMarkdown = createHiveRenderer();\r\n"],"mappings":"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","names":["DOMPurify","renderHiveMarkdown"]}