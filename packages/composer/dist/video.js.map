{"version":3,"sources":["../src/video.ts"],"sourcesContent":["/**\n * @snapie/composer/video - Video Upload Module\n * \n * Optional module for 3Speak video upload integration.\n * Only import this if you need video upload functionality.\n * \n * @example\n * ```typescript\n * import { uploadVideoTo3Speak } from '@snapie/composer/video';\n * \n * const result = await uploadVideoTo3Speak(file, {\n *   apiKey: '...',\n *   owner: 'username',\n *   onProgress: (progress, status) => console.log(progress, status)\n * });\n * \n * console.log(result.embedUrl);\n * ```\n */\n\n/**\n * Video upload progress callback\n */\nexport type VideoProgressCallback = (\n    progress: number, \n    status: 'uploading' | 'processing' | 'complete' | 'error'\n) => void;\n\n/**\n * Video upload result\n */\nexport interface VideoUploadResult {\n    /** The embed URL to include in posts */\n    embedUrl: string;\n    /** The video ID (permlink part) */\n    videoId: string;\n}\n\n/**\n * Options for video upload\n */\nexport interface VideoUploadOptions {\n    /** 3Speak API key */\n    apiKey: string;\n    /** Hive username of the uploader */\n    owner: string;\n    /** App name for metadata (default: \"snapie\") */\n    appName?: string;\n    /** Progress callback */\n    onProgress?: VideoProgressCallback;\n}\n\n/**\n * Upload a video to 3Speak using TUS protocol\n * \n * @param file - Video file to upload\n * @param options - Upload options\n * @returns Promise resolving to embed URL and video ID\n */\nexport async function uploadVideoTo3Speak(\n    file: File,\n    options: VideoUploadOptions\n): Promise<VideoUploadResult> {\n    // Dynamic import to avoid bundling tus-js-client when not needed\n    const tus = await import('tus-js-client');\n    \n    return new Promise((resolve, reject) => {\n        let embedUrl: string | null = null;\n        \n        const upload = new tus.Upload(file, {\n            endpoint: 'https://embed.3speak.tv/uploads',\n            retryDelays: [0, 3000, 5000, 10000, 20000],\n            metadata: {\n                filename: file.name,\n                owner: options.owner,\n                frontend_app: options.appName ?? 'snapie',\n                short: 'true'\n            },\n            headers: {\n                'X-API-Key': options.apiKey\n            },\n            onError: (error) => {\n                options.onProgress?.(0, 'error');\n                reject(error);\n            },\n            onProgress: (bytesUploaded, bytesTotal) => {\n                const percentage = (bytesUploaded / bytesTotal) * 100;\n                options.onProgress?.(Math.round(percentage), 'uploading');\n            },\n            onAfterResponse: (req, res) => {\n                const url = res.getHeader('X-Embed-URL');\n                if (url) {\n                    embedUrl = url;\n                }\n            },\n            onSuccess: () => {\n                if (embedUrl) {\n                    options.onProgress?.(100, 'complete');\n                    const videoId = extractVideoIdFromEmbedUrl(embedUrl);\n                    resolve({\n                        embedUrl,\n                        videoId: videoId ?? ''\n                    });\n                } else {\n                    options.onProgress?.(0, 'error');\n                    reject(new Error('Failed to get embed URL from server'));\n                }\n            }\n        });\n        \n        upload.start();\n    });\n}\n\n/**\n * Extract video ID from 3Speak embed URL\n * \n * @example\n * // Input: \"https://play.3speak.tv/embed?v=username/abc123\"\n * // Output: \"abc123\"\n */\nexport function extractVideoIdFromEmbedUrl(embedUrl: string): string | null {\n    try {\n        const url = new URL(embedUrl);\n        const videoParam = url.searchParams.get('v');\n        if (videoParam) {\n            const parts = videoParam.split('/');\n            return parts[1] ?? null;\n        }\n        return null;\n    } catch {\n        return null;\n    }\n}\n\n/**\n * Set thumbnail for a 3Speak video\n * \n * @param videoId - The video ID (permlink part, e.g., \"abc123\")\n * @param thumbnailUrl - URL of the thumbnail image\n * @param apiKey - 3Speak API key\n */\nexport async function set3SpeakThumbnail(\n    videoId: string,\n    thumbnailUrl: string,\n    apiKey: string\n): Promise<void> {\n    const response = await fetch(`https://embed.3speak.tv/video/${videoId}/thumbnail`, {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/json',\n            'X-API-Key': apiKey\n        },\n        body: JSON.stringify({ thumbnail_url: thumbnailUrl })\n    });\n    \n    if (!response.ok) {\n        throw new Error(`Failed to set thumbnail: ${response.status} - ${response.statusText}`);\n    }\n}\n\n/**\n * Extract a thumbnail frame from a video file (browser only)\n * \n * @param file - Video file\n * @param seekTime - Time in seconds to capture frame (default: 0.5)\n * @returns Promise resolving to thumbnail blob\n */\nexport async function extractVideoThumbnail(\n    file: File,\n    seekTime: number = 0.5\n): Promise<Blob> {\n    return new Promise((resolve, reject) => {\n        const url = URL.createObjectURL(file);\n        const video = document.createElement('video');\n        \n        video.src = url;\n        video.crossOrigin = 'anonymous';\n        video.muted = true;\n        \n        video.addEventListener('loadeddata', () => {\n            video.currentTime = seekTime;\n        });\n        \n        video.addEventListener('seeked', () => {\n            const canvas = document.createElement('canvas');\n            canvas.width = video.videoWidth;\n            canvas.height = video.videoHeight;\n            \n            const ctx = canvas.getContext('2d');\n            if (!ctx) {\n                reject(new Error('Failed to get canvas context'));\n                return;\n            }\n            \n            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);\n            \n            canvas.toBlob(\n                (blob) => {\n                    URL.revokeObjectURL(url);\n                    if (blob) {\n                        resolve(blob);\n                    } else {\n                        reject(new Error('Failed to create thumbnail blob'));\n                    }\n                },\n                'image/jpeg',\n                0.9\n            );\n        });\n        \n        video.addEventListener('error', () => {\n            URL.revokeObjectURL(url);\n            reject(new Error('Failed to load video'));\n        });\n        \n        video.load();\n    });\n}\n\n/**\n * Upload a file to IPFS (3Speak supernode)\n * \n * @param file - File or Blob to upload\n * @param endpoint - IPFS API endpoint (default: 3Speak supernode)\n * @returns IPFS URL of the uploaded file\n */\nexport async function uploadToIPFS(\n    file: File | Blob,\n    endpoint: string = 'http://65.21.201.94:5002/api/v0/add'\n): Promise<string> {\n    const formData = new FormData();\n    formData.append('file', file);\n    \n    const response = await fetch(endpoint, {\n        method: 'POST',\n        body: formData\n    });\n    \n    if (!response.ok) {\n        throw new Error(`IPFS upload failed: ${response.status} - ${response.statusText}`);\n    }\n    \n    const responseText = await response.text();\n    const lines = responseText.trim().split('\\n');\n    const lastLine = lines[lines.length - 1];\n    const result = JSON.parse(lastLine);\n    \n    return `https://ipfs.3speak.tv/ipfs/${result.Hash}`;\n}\n\n/**\n * Helper to upload video with automatic thumbnail generation\n * \n * @param file - Video file\n * @param options - Upload options including API key\n * @returns Video upload result with optional thumbnail URL\n */\nexport async function uploadVideoWithThumbnail(\n    file: File,\n    options: VideoUploadOptions & { \n        /** Custom thumbnail upload function */\n        uploadThumbnail?: (blob: Blob) => Promise<string>;\n    }\n): Promise<VideoUploadResult & { thumbnailUrl?: string }> {\n    // Start video upload and thumbnail extraction in parallel\n    const [videoResult, thumbnailBlob] = await Promise.all([\n        uploadVideoTo3Speak(file, options),\n        extractVideoThumbnail(file).catch(() => null)\n    ]);\n    \n    let thumbnailUrl: string | undefined;\n    \n    if (thumbnailBlob) {\n        try {\n            // Upload thumbnail\n            thumbnailUrl = options.uploadThumbnail \n                ? await options.uploadThumbnail(thumbnailBlob)\n                : await uploadToIPFS(thumbnailBlob);\n            \n            // Set it on 3Speak\n            if (videoResult.videoId) {\n                await set3SpeakThumbnail(videoResult.videoId, thumbnailUrl, options.apiKey);\n            }\n        } catch (error) {\n            console.warn('Thumbnail processing failed (video still works):', error);\n        }\n    }\n    \n    return {\n        ...videoResult,\n        thumbnailUrl\n    };\n}\n"],"mappings":"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","names":[]}